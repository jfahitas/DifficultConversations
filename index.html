<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Difficult Conversations Tool</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.8s ease-in-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-in-out; }
    body { font-family: sans-serif; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; margin-top: 1.5rem; color: #3B3168; }
    .prose h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 1rem; }
    .prose p { margin-bottom: 1rem; }
    .prose ul { list-style-position: inside; list-style-type: disc; margin-bottom: 1rem; margin-left: 1rem; }
    .prose li { margin-bottom: 0.25rem; }
    .prose strong { font-weight: 600; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    // Deconstruct necessary libraries from window object
    const { useState, useEffect, forwardRef, useMemo } = React;
    const { CheckCircle, XCircle, Loader2 } = lucide;

    // A simple version of the 'cn' utility for merging class names
    const cn = (...inputs) => {
      return inputs.filter(Boolean).join(' ');
    }
    
    //=========== DATA FILES ===========//

    // data/answerBank.ts
    const answerBank = [
        {
            keywords: ["feedback", "boss", "manager", "upward"],
            content: `## Giving Feedback to Your Manager

Giving feedback to your boss requires careful navigation. The goal is to be helpful and constructive without seeming critical or insubordinate. Here‚Äôs a proven framework to structure your conversation.

### 1. Check Your Intent & Ask for Permission
Before you begin, ensure your motive is to help the team or project succeed. Start by asking for permission to share your thoughts. This shows respect for their position and prepares them to listen.

- **Example:** *"I have some thoughts on the new project workflow that I think could help us move faster. Would you be open to hearing them?"*

### 2. Use the Situation-Behavior-Impact (SBI) Model
This model keeps feedback objective and focused on facts, not accusations.
- **Situation:** Describe the specific context.
- **Behavior:** Describe the specific, observable action or behavior.
- **Impact:** Explain the concrete effect the behavior had on you, the team, or the work.

- **Example:** *"During **(S)** this morning's client call, **(B)** when the new mockups were presented as final, **(I)** it caused some confusion for the client and meant we had to walk back expectations later on."*

### 3. Propose a Collaborative Solution
After presenting the feedback, pivot to a solution-oriented approach. Frame it as a suggestion or a question to invite collaboration.

- **Example:** *"Moving forward, perhaps we could align on the status of deliverables before client calls to ensure we present a unified front. What are your thoughts on that?"*

By following this structure, you frame your feedback as a valuable, objective observation aimed at mutual success.`
        },
        {
            keywords: ["conflict", "team", "argue", "disagree"],
            content: `## Resolving Team Conflict

When mediating conflict between team members, your role is to facilitate a productive conversation, not to pick a side. The goal is to help both parties feel heard and guide them toward a mutually agreeable solution.

### 1. Meet Individually First
Before bringing the team members together, meet with each one separately. This allows you to understand their perspective without the pressure of a confrontation. Listen actively and validate their feelings without agreeing with their position.

- **What to say:** *"Help me understand your perspective on what happened in the project meeting."*

### 2. Facilitate a Joint Conversation
Bring both individuals together. Your job is to create a safe space and keep the conversation constructive.
- **Set Ground Rules:** Start by establishing rules, such as "no interruptions" and "focus on the problem, not the person."
- **Find Common Ground:** Reframe the issue around a shared goal.
- **Example:** *"I know you both are committed to making this project a success. Let's focus on how we can get there. From my understanding, we're misaligned on the best approach for the launch."*

### 3. Guide Them to a Solution
Encourage each person to state what they need to move forward. Help them brainstorm solutions that can meet both of their underlying interests.

- **What to say:** *"Alex, what do you need from Jordan to feel confident in the project plan? Jordan, what do you need from Alex to maintain flexibility?"*

Document the agreed-upon solution and follow up to ensure the conflict is truly resolved.`
        },
        {
            keywords: ["default", "general", "help"],
            content: `## General Guidance for Difficult Conversations

Navigating difficult conversations is a critical leadership skill. While every situation is unique, a few core principles can guide you toward a more productive outcome.

### 1. Start with Heart (Know Your Goal)
Before you say anything, be clear on what you truly want as an outcome for yourself, for the other person, and for the relationship. When conversations get tough, use your goal as an anchor to stay focused and avoid getting sidetracked by emotion.

- **Ask yourself:** *"What do I really want to achieve with this conversation?"*

### 2. Make it Safe
People become defensive when they don't feel psychologically safe. If you see signs of fear or anger (silence or violence), step out of the content of the conversation and rebuild safety. You can do this by showing respect and clarifying your positive intentions.

- **Example:** *"I can see this is frustrating. I want to be clear that my intention is not to blame anyone, but to understand what happened so we can prevent it from happening again."*

### 3. Focus on Facts, Not Stories
Separate what you observed from the story you told yourself about it. Start conversations by sharing the observable facts, which are less likely to be disputed.

- **Instead of:** *"You were trying to undermine me in that meeting."*
- **Try:** *"In the meeting, when I was presenting, I was interrupted several times. I'm concerned about the impact that had on the team's understanding of the plan."*

By mastering these principles, you can turn difficult conversations from confrontations into opportunities for growth and stronger relationships.`
        },
    ];

    const searchAnswers = (question) => {
        const queryWords = question.toLowerCase().match(/\b(\w+)\b/g) || [];
        if (queryWords.length === 0) return [];

        const scoredAnswers = answerBank.map(answer => {
            let score = 0;
            answer.keywords.forEach(keyword => {
                if (queryWords.includes(keyword)) {
                    score++;
                }
            });
            return { ...answer, score };
        });

        return scoredAnswers.filter(a => a.score > 0).sort((a, b) => b.score - a.score);
    };

    const getDefaultAnswer = () => answerBank.find(a => a.keywords.includes("default"));

    // data/scenarios.ts
    const scenarios = [
      { id: 1, title: "Delivering Critical Performance Feedback", description: "Navigate a challenging conversation with an underperforming team member who has been missing deadlines.", category: "Performance Management", difficulty: "Intermediate", estimatedTime: "10-15 min", completed: false, questions: [{ id: 1, question: "When approaching this conversation, what should be your primary focus?", options: ["Focus on her personal issues that might be causing the delays", "Document the pattern of missed deadlines and their business impact", "Compare her performance to other team members to motivate her", "Wait another month to see if the pattern continues"], correctAnswer: 1, feedback: ["Correct! Documentation of specific instances and business impact creates a foundation for productive conversation.", "Focusing on business impact rather than personal issues keeps the conversation professional and actionable.", "This approach follows the SBI model (Situation-Behavior-Impact)."] }, { id: 2, question: "When starting the feedback conversation, which opening would be most effective?", options: ["\"Sarah, we need to talk about your performance issues.\"", "\"Sarah, I've noticed a pattern with project deadlines that I'd like to discuss. Can we talk about what's happening?\"", "\"Sarah, I'm disappointed in your recent work quality.\"", "\"Sarah, other team members are complaining about your missed deadlines.\""], correctAnswer: 1, feedback: ["Excellent choice! This opening is specific, non-judgmental, and invites dialogue.", "Starting with observations rather than judgments creates psychological safety for honest conversation.", "The phrase 'what's happening' shows curiosity rather than accusation."] }, { id: 3, question: "During the conversation, Sarah becomes defensive and says \"I'm doing my best!\" How should you respond?", options: ["\"Clearly your best isn't good enough for this role.\"", "\"I believe you are trying hard. Let's talk about what might help you meet these deadlines consistently.\"", "\"Everyone else manages to meet their deadlines.\"", "\"Your best needs to improve significantly.\""], correctAnswer: 1, feedback: ["Perfect! This response acknowledges her effort while redirecting to problem-solving.", "Using 'AND' instead of 'BUT' maintains both truths: she's trying AND deadlines are being missed.", "This approach focuses on finding solutions rather than assigning blame."] }] },
      { id: 2, title: "Addressing Team Conflict", description: "Mediate between two team members who have different working styles and are clashing on a critical project.", category: "Conflict Resolution", difficulty: "Advanced", estimatedTime: "15-20 min", completed: false, questions: [{ id: 4, question: "Two team members are in conflict over project approach. What's your first step?", options: ["Tell them to figure it out themselves", "Choose the approach you think is better and mandate it", "Meet with each person individually to understand their perspectives", "Immediately bring them together for a group discussion"], correctAnswer: 2, feedback: ["Excellent! Individual meetings help you understand each perspective without the pressure of defending positions.", "This approach prevents the conflict from escalating and gives you complete information.", "Understanding each person's underlying concerns is crucial for finding sustainable solutions."] }, { id: 5, question: "In your individual meeting with Alex, they say \"Jordan never plans anything and it's causing chaos.\" How do you respond?", options: ["\"I can see why that would be frustrating for someone who values planning.\"", "\"Jordan actually does plan, just differently than you do.\"", "\"You need to be more flexible with different working styles.\"", "\"That's not really true - Jordan has good ideas.\""], correctAnswer: 0, feedback: ["Great choice! This validates Alex's experience without agreeing that Jordan is wrong.", "Acknowledging feelings helps people feel heard, which is essential before problem-solving.", "This response avoids taking sides while showing empathy."] }, { id: 6, question: "When facilitating the joint conversation, both team members start blaming each other. What's your best intervention?", options: ["\"Let's stop the blame game and focus on solutions.\"", "\"I can see you both care deeply about this project's success. Let's talk about what that would look like.\"", "\"You're both being unprofessional right now.\"", "\"Alex is right about needing more planning.\""], correctAnswer: 1, feedback: ["Perfect! This reframes the conflict around shared goals rather than individual positions.", "Highlighting common ground helps people shift from adversarial to collaborative mindset.", "This technique, called 'finding the third story,' helps people see beyond their individual perspectives."] }] },
      { id: 3, title: "Salary Negotiation Discussion", description: "Handle a request for a significant salary increase during a budget-constrained period.", category: "Compensation", difficulty: "Intermediate", estimatedTime: "10-15 min", completed: false, questions: [{ id: 7, question: "Your top performer requests a 20% salary increase, but your budget is frozen. What's your best approach?", options: ["\"Sorry, there's no money in the budget right now.\"", "\"Let me understand what's driving this request, and then I'll share what options we might have.\"", "\"That's way too much - maybe we can do 5%.\"", "\"Let me think about it and get back to you.\""], correctAnswer: 1, feedback: ["Excellent approach! Understanding the 'why' behind the request helps you address the real need.", "This shows respect for their request while being honest about constraints.", "Opening with curiosity rather than limitations creates space for creative solutions."] }, { id: 8, question: "The employee explains they've gotten an offer from another company. How do you respond?", options: ["\"Well, if you want to leave, that's your choice.\"", "\"I can't match that offer, so I guess you'll have to decide.\"", "\"I value your contribution here. Let's talk about what would make staying the right choice for you.\"", "\"Other companies always promise more than they deliver.\""], correctAnswer: 2, feedback: ["Great response! This acknowledges their value while opening discussion about retention beyond just salary.", "This approach explores the total value proposition, not just monetary compensation.", "Focusing on what makes staying attractive shows you're invested in finding a win-win solution."] }, { id: 9, question: "You can't match the salary offer. What's your best alternative approach?", options: ["Promise a salary increase next year", "Offer a one-time bonus instead", "Explore other valuable benefits: flexible schedule, professional development budget, or expanded responsibilities", "Try to convince them the other company isn't as good"], correctAnswer: 2, feedback: ["Perfect! Creative compensation goes beyond salary to address what people truly value.", "This approach recognizes that career satisfaction involves multiple factors beyond base pay.", "Offering growth opportunities and flexibility can be as valuable as monetary increases."] }] },
      { id: 4, title: "Managing Up: Challenging Your Boss's Decision", description: "Respectfully disagree with your manager's strategic decision that you believe could harm your team's success.", category: "Managing Up", difficulty: "Advanced", estimatedTime: "10-15 min", completed: false, questions: [{ id: 10, question: "Your boss has cut your project timeline by 30%, which you believe will compromise quality. What's your approach?", options: ["Go along with it to avoid conflict", "Tell them directly that it's a bad decision", "Request a private meeting to share your concerns and explore alternatives", "Complain to your boss's manager"], correctAnswer: 2, feedback: ["Excellent choice! A private meeting shows respect while creating space for honest dialogue.", "This approach demonstrates professionalism and gives your boss an opportunity to explain their reasoning.", "Requesting a meeting rather than confronting in the moment shows you take the issue seriously."]}, { id: 11, question: "How should you start this difficult conversation with your boss?", options: ["\"I think you're making a mistake with this timeline.\"", "\"I wanted to understand your thinking on the new timeline and share some concerns I have.\"", "\"This timeline is completely unrealistic.\"", "\"The team is upset about this decision.\""], correctAnswer: 1, feedback: ["Perfect opening! This shows genuine curiosity about their perspective before sharing yours.", "Starting with understanding rather than disagreement creates a collaborative tone.", "This approach follows the principle of seeking first to understand, then to be understood."]}, { id: 12, question: "Your boss explains they're under pressure from senior leadership. How do you respond?", options: ["\"That's not my problem - I'm telling you what my team needs.\"", "\"I understand you're in a difficult position. Let me share what I'm seeing from the implementation side.\"", "\"Senior leadership doesn't understand our work.\"", "\"You need to push back on them.\""], correctAnswer: 1, feedback: ["Excellent! This acknowledges their constraint while positioning yourself as a partner in problem-solving.", "Showing empathy for their position makes them more likely to listen to your concerns.", "This response creates 'us against the problem' rather than 'me against you' dynamic."] }] },
      { id: 5, title: "Delivering Disappointing News", description: "Inform your team about budget cuts that will affect their projects and potentially their job security.", category: "Change Management", difficulty: "Advanced", estimatedTime: "12-18 min", completed: false, questions: [{ id: 13, question: "You need to tell your team about significant budget cuts. What's your preparation priority?", options: ["Prepare answers for every possible question they might ask", "Plan how to minimize the impact in your communication", "Gather clear information about what you can and cannot share, and prepare for honest dialogue", "Wait until you have all the details figured out"], correctAnswer: 2, feedback: ["Excellent preparation! Honesty about what you know and don't know builds trust during difficult times.", "Being transparent about constraints shows respect for your team's intelligence.", "Preparing for dialogue rather than just delivering news shows you value their input and concerns."]}, { id: 14, question: "How should you structure the team meeting to deliver this news?", options: ["Start with small talk to ease into the bad news", "Begin with the news directly, then provide context and next steps", "End the meeting with the news so people can process it privately", "Send an email instead of meeting face-to-face"], correctAnswer: 1, feedback: ["Right approach! Leading with the main news respects people's need to know.", "This structure prevents people from being distracted wondering 'why are we here?'.", "Direct communication followed by support and context shows both respect and care for your team."]}, { id: 15, question: "A team member asks \"Does this mean layoffs are coming?\" and you genuinely don't know. How do you respond?", options: ["\"I don't think so, but I can't guarantee anything.\"", "\"Don't worry about that right now.\"", "\"I honestly don't have information about layoffs. What I can tell you is what I do know about our situation.\"", "\"That's above my pay grade.\""], correctAnswer: 2, feedback: ["Perfect response! Honest uncertainty is better than false reassurance or deflection.", "This response acknowledges their concern while being truthful about what you can and cannot say.", "Following up with what you DO know helps people feel informed rather than left in uncertainty."] }] }
    ];

    //=========== SERVICES ===========//
    
    // services/geminiService.ts
    async function getWorkplaceGuidance(question) {
      await new Promise(resolve => setTimeout(resolve, 1500));
      const matches = searchAnswers(question);
      const selectedAnswer = matches.length > 0 ? matches[0] : getDefaultAnswer();
      
      function convertMarkdownToHtml(text) {
          let html = text.replace(/\n/g, '<br>'); // Basic newline to <br>
          // More complex replacements needed to be wrapped correctly.
          html = html.replace(/## (.*?)<br>/g, '<h2>$1</h2>');
          html = html.replace(/### (.*?)<br>/g, '<h3>$1</h3>');
          html = html.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
          html = html.replace(/^- (.*?)<br>/g, '<li>$1</li>');
          html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>').replace(/<\/li><ul>/g, '</li>');
          html = html.replace(/<br>/g, '</p><p>'); // Convert remaining line breaks to paragraphs
          return `<div class="prose max-w-none"><p>${html}</p></div>`;
      }
      
      return convertMarkdownToHtml(selectedAnswer.content);
    }
    
    //=========== UI COMPONENTS ===========//
    function Button({ className, variant, children, ...props }) {
      const baseClasses = "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors disabled:pointer-events-none disabled:opacity-50";
      const variantClasses = {
        default: "bg-[#3B3168] hover:bg-[#2c254d] text-white",
        link: "text-[#3B3168] hover:text-[#2c254d] underline-offset-4 hover:underline",
      };
      const finalClasses = cn(baseClasses, variantClasses[variant] || variantClasses.default, className);
      return <button className={finalClasses} {...props}>{children}</button>;
    }
    
    function Card({ className, children, ...props }) {
        return <div className={cn("rounded-lg border bg-white text-gray-800 shadow-sm", className)} {...props}>{children}</div>
    }

    function Badge({ className, variant, children, ...props }) {
      const variantClasses = {
        secondary: "bg-[#3B3168]/10 text-[#3B3168]",
        outline: "text-foreground",
      };
      const baseClasses = "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold";
      return <div className={cn(baseClasses, variantClasses[variant], className)} {...props}>{children}</div>;
    }

    function Progress({ value, className }) {
        return (
            <div className={cn("relative h-2 w-full overflow-hidden rounded-full bg-gray-200", className)}>
                <div 
                    className="h-full w-full flex-1 bg-[#3B3168] transition-all"
                    style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
                />
            </div>
        );
    }

    function Textarea({ className, ...props }) {
        return <textarea className={cn("flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base ring-offset-background placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#3B3168] disabled:cursor-not-allowed disabled:opacity-50", className)} {...props} />;
    }

    //=========== PAGE COMPONENTS ===========//

    function HomePage({ onPageChange, logoUrl }) {
      return (
        <div className="text-center animate-fadeIn">
          <div className="mb-8">
            <h1 className="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-[#3B3168] to-[#2c254d] bg-clip-text text-transparent">
              Handling Difficult Conversations
            </h1>
            <p className="text-xl text-gray-600 mb-2">A Leader's Tool</p>
            <p className="text-lg text-gray-500 max-w-3xl mx-auto leading-relaxed">
              Master workplace communication through interactive scenarios. Build confidence in navigating challenging conversations with proven frameworks.
            </p>
          </div>
          <div className="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            <Card className="p-8 hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer border-2 hover:border-[#3B3168]/20" onClick={() => onPageChange('scenarios')}>
              <div className="w-16 h-16 bg-gradient-to-br from-[#3B3168] to-[#2c254d] rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span className="text-2xl text-white">üéØ</span>
              </div>
              <h3 className="text-2xl font-bold mb-3 text-[#3B3168]">Interactive Scenarios</h3>
              <p className="text-gray-600 mb-6 leading-relaxed">
                Practice with realistic workplace scenarios. Each scenario includes multiple-choice questions with detailed feedback.
              </p>
              <Button>Start Training</Button>
            </Card>
            <Card className="p-8 hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer border-2 hover:border-[#3B3168]/20" onClick={() => onPageChange('qa')}>
              <div className="w-16 h-16 bg-gradient-to-br from-[#3B3168] to-[#2c254d] rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span className="text-2xl text-white">üí°</span>
              </div>
              <h3 className="text-2xl font-bold mb-3 text-[#3B3168]">Ask a Question</h3>
              <p className="text-gray-600 mb-6 leading-relaxed">
                Get personalized guidance for your specific challenges. Our expert knowledge base provides actionable advice.
              </p>
              <Button>Get Guidance</Button>
            </Card>
          </div>
           <div className="mt-12 p-6 bg-gray-100 rounded-xl">
              <h4 className="text-lg font-bold mb-3 text-[#3B3168]">Grounded in Research</h4>
              <p className="text-gray-600 text-sm leading-relaxed">
                All guidance is based on proven frameworks from "Crucial Conversations," "Difficult Conversations," and "Radical Candor".
              </p>
            </div>
        </div>
      );
    }
    
    function ScenariosPage({ scenarios, onPageChange, onScenarioSelect }) {
      const completedCount = scenarios.filter(s => s.completed).length;
      return (
        <div className="animate-slideUp">
          <Button onClick={() => onPageChange('home')} variant="link" className="mb-6 p-0">
            ‚Üê Back to Home
          </Button>
          <div className="text-center mb-8">
            <h2 className="text-3xl font-bold mb-4">Training Scenarios</h2>
            <p className="text-gray-600 mb-4">
              Practice difficult conversations in a safe environment.
            </p>
            <div className="text-sm text-gray-500">
              Progress: {completedCount} of {scenarios.length} scenarios completed
            </div>
          </div>
          <div className="grid gap-6">
            {scenarios.map((scenario) => (
              <Card key={scenario.id} className="p-6 hover:shadow-lg transition-all duration-300 hover:-translate-y-1 cursor-pointer border-2 hover:border-[#3B3168]/20" onClick={() => onScenarioSelect(scenario.id)}>
                <div className="flex items-center gap-3 mb-2">
                  <h3 className="text-xl font-bold text-[#3B3168]">{scenario.title}</h3>
                  {scenario.completed && <CheckCircle className="h-5 w-5 text-green-500" />}
                </div>
                <p className="text-gray-600 mb-4">{scenario.description}</p>
                 <div className="flex flex-wrap gap-2 mb-4">
                   <Badge variant="secondary">{scenario.category}</Badge>
                   <Badge variant="outline" className={`${scenario.difficulty === 'Beginner' ? 'border-green-500 text-green-700' : ''} ${scenario.difficulty === 'Intermediate' ? 'border-yellow-500 text-yellow-700' : ''} ${scenario.difficulty === 'Advanced' ? 'border-red-500 text-red-700' : ''}`}>{scenario.difficulty}</Badge>
                 </div>
                <Button onClick={(e) => { e.stopPropagation(); onScenarioSelect(scenario.id); }}>
                  {scenario.completed ? 'Review Scenario' : 'Start Scenario'}
                </Button>
              </Card>
            ))}
          </div>
        </div>
      );
    }

    function ScenarioDetailPage({ scenario, onPageChange, onScenarioComplete }) {
      const [selectedAnswers, setSelectedAnswers] = useState({});
      const [showResults, setShowResults] = useState(false);
      const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

      const isLastQuestion = currentQuestionIndex === scenario.questions.length - 1;
      const currentQuestion = scenario.questions[currentQuestionIndex];
      const hasAnswered = selectedAnswers[currentQuestion.id] !== undefined;
      const selectedAnswer = selectedAnswers[currentQuestion.id];
      const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
      const progress = ((currentQuestionIndex + 1) / scenario.questions.length) * 100;

      const handleAnswerSelect = (questionId, answerIndex) => {
        setSelectedAnswers(prev => ({ ...prev, [questionId]: answerIndex }));
        setShowResults(true);
      };

      const handleNext = () => {
        if (isLastQuestion) {
          onScenarioComplete();
        } else {
          setCurrentQuestionIndex(prev => prev + 1);
          setShowResults(false);
        }
      };

      return (
        <div className="animate-slideUp">
          <Button onClick={() => onPageChange('scenarios')} variant="link" className="mb-6 p-0">
            ‚Üê Back to Scenarios
          </Button>
          <div className="mb-6">
            <h2 className="text-2xl font-bold mb-4">{scenario.title}</h2>
            <div className="flex justify-between text-sm text-gray-600 mb-2">
              <span>Question {currentQuestionIndex + 1} of {scenario.questions.length}</span>
              <span>{Math.round(progress)}% Complete</span>
            </div>
            <Progress value={progress} />
          </div>
          <Card className="p-8 mb-6">
            <h3 className="text-xl font-bold mb-4">{currentQuestion.question}</h3>
            <div className="space-y-3">
              {currentQuestion.options.map((option, index) => (
                <button key={index} onClick={() => handleAnswerSelect(currentQuestion.id, index)} disabled={hasAnswered} className={cn('w-full p-4 text-left border-2 rounded-lg transition-all', hasAnswered ? (index === currentQuestion.correctAnswer ? 'border-green-500 bg-green-50' : (index === selectedAnswer ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-gray-50')) : 'border-gray-300 hover:border-[#3B3168] hover:bg-[#3B3168]/5')}>
                  <div className="flex items-center justify-between">
                    <span>{option}</span>
                    {hasAnswered && (index === currentQuestion.correctAnswer ? <CheckCircle className="h-5 w-5 text-green-500" /> : (index === selectedAnswer ? <XCircle className="h-5 w-5 text-red-500" /> : null))}
                  </div>
                </button>
              ))}
            </div>
          </Card>
          {showResults && (
            <Card className="p-6 mb-6 animate-slideUp">
              <h4 className={cn('font-bold mb-2', isCorrect ? 'text-green-800' : 'text-red-800')}>{isCorrect ? 'Correct!' : 'Not quite right.'}</h4>
              <div className="space-y-3">
                {currentQuestion.feedback.map((fb, i) => <p key={i} className="text-gray-700">{fb}</p>)}
              </div>
            </Card>
          )}
          {hasAnswered && (
            <div className="text-center">
              <Button onClick={handleNext}>{isLastQuestion ? 'Complete Scenario' : 'Next Question'}</Button>
            </div>
          )}
        </div>
      );
    }

    function QAPage({ onPageChange, qaState, onQuestionChange, onSubmitQuestion }) {
        return (
            <div className="animate-slideUp">
                <Button onClick={() => onPageChange('home')} variant="link" className="mb-6 p-0">
                    ‚Üê Back to Home
                </Button>
                <Card className="p-8 shadow-lg">
                    <h2 className="text-3xl font-bold mb-2">Ask a Question</h2>
                    <p className="mb-6 text-gray-600">
                        Describe a difficult conversation you're facing to get expert guidance from our knowledge base.
                    </p>
                    <Textarea
                        value={qaState.question}
                        onChange={(e) => onQuestionChange(e.target.value)}
                        className="min-h-32"
                        placeholder="E.g., How do I give feedback to my boss?"
                    />
                    <div className="mt-4 text-right">
                        <Button onClick={onSubmitQuestion} disabled={qaState.isLoading} className="px-6 py-3">
                            {qaState.isLoading ? <div className="flex items-center"><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Getting Guidance...</div> : 'Get Guidance'}
                        </Button>
                    </div>
                    <div className="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px]">
                        {qaState.response ? <div dangerouslySetInnerHTML={{ __html: qaState.response }} /> : <p className="text-gray-500">Your guidance will appear here.</p>}
                    </div>
                </Card>
            </div>
        );
    }
    
    //=========== MAIN APP COMPONENT ===========//

    function App() {
      const [page, setPage] = useState('home');
      const [scenariosData, setScenariosData] = useState(scenarios);
      const [selectedScenarioId, setSelectedScenarioId] = useState(null);
      const [qaState, setQaState] = useState({ question: '', response: '', isLoading: false });

      const selectedScenario = scenariosData.find(s => s.id === selectedScenarioId);

      useEffect(() => { window.scrollTo(0, 0); }, [page]);

      const handleScenarioComplete = () => {
        if (selectedScenarioId === null) return;
        setScenariosData(prev => prev.map(s => s.id === selectedScenarioId ? { ...s, completed: true } : s));
        setPage('scenarios');
      };
      
      const handleQuestionSubmit = async () => {
        setQaState(prev => ({ ...prev, isLoading: true, response: '' }));
        const responseHtml = await getWorkplaceGuidance(qaState.question);
        setQaState(prev => ({ ...prev, isLoading: false, response: responseHtml }));
      };
      
      const handleScenarioSelect = (id) => {
        setSelectedScenarioId(id);
        setPage('scenario-detail');
      };

      const renderPage = () => {
        switch (page) {
          case 'scenarios':
            return <ScenariosPage scenarios={scenariosData} onPageChange={setPage} onScenarioSelect={handleScenarioSelect} />;
          case 'scenario-detail':
            return selectedScenario ? <ScenarioDetailPage scenario={selectedScenario} onPageChange={setPage} onScenarioComplete={handleScenarioComplete} /> : null;
          case 'qa':
            return <QAPage onPageChange={setPage} qaState={qaState} onQuestionChange={(q) => setQaState(prev => ({ ...prev, question: q }))} onSubmitQuestion={handleQuestionSubmit} />;
          case 'home':
          default:
            return <HomePage onPageChange={setPage} />;
        }
      };

      return (
        <div className="min-h-screen">
          <main className="container mx-auto p-4 md:p-8 max-w-5xl">
            {renderPage()}
          </main>
          <footer className="text-center p-4 mt-8 text-sm text-gray-400">
            <p>&copy; 2025 Workplace Communication Tools</p>
          </footer>
        </div>
      );
    }

    //=========== RENDER THE APP ===========//
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
